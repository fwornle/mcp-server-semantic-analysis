@startuml agent-coordination-flow
!include /Users/q284340/Agentic/coding/docs/puml/_standard-style.puml

title 14-Agent Coordination Flow

participant "Claude Code" as CLAUDE
participant "MCP Handler" as MCP
participant "Coordinator Agent" as COORD #FFE6CC
participant "Git History Agent" as GIT #E6F3FF
participant "Vibe History Agent" as VIBE #E6F3FF
participant "Semantic Analysis Agent" as SEMANTIC #E6F3FF
participant "Web Search Agent" as WEB #E6F3FF
participant "Insight Generation Agent" as INSIGHT #E6F3FF
participant "Observation Generation Agent" as OBS #FFE6E6
participant "Quality Assurance Agent" as QA #FFE6E6
participant "Content Validation Agent" as CONTENT #FFE6E6
participant "Git Staleness Detector" as STALE #E6FFE6
participant "Persistence Agent" as PERSIST #E6FFE6
participant "Deduplication Agent" as DEDUP #E6FFE6
participant "Ontology Classification Agent" as ONTOLOGY #E6F3FF
participant "Code Graph Agent" as CODEGRAPH #E6F3FF
participant "Documentation Linker Agent" as DOCLINK #E6F3FF
database "GraphDB" as GRAPHDB #D4EDDA

CLAUDE ->> MCP : tool_call(execute_workflow)
activate MCP

MCP ->> COORD : execute_workflow(complete-analysis)
activate COORD

note over COORD
  Orchestrate 13-worker-agent workflow
  Initialize GraphDB adapter
  Manage task dependencies
end note

== Data Collection Phase ==

COORD ->> GIT : analyze_git_history()
activate GIT
GIT -->> COORD : git_analysis_results
deactivate GIT

COORD ->> VIBE : analyze_vibe_history()
activate VIBE
note right of VIBE: Uses LLM
VIBE -->> COORD : vibe_analysis_results
deactivate VIBE

== Analysis Phase ==

COORD ->> SEMANTIC : analyze_semantics(git, vibe)
activate SEMANTIC
note right of SEMANTIC: Uses LLM
SEMANTIC -->> COORD : semantic_analysis
deactivate SEMANTIC

COORD ->> WEB : search_patterns(semantic)
activate WEB
note right of WEB: Uses LLM
WEB -->> COORD : web_results
deactivate WEB

== Generation Phase ==

COORD ->> INSIGHT : generate_insights(all_results)
activate INSIGHT
note right of INSIGHT
  Uses LLM for:
  - Document generation
  - Diagram creation
  - PlantUML repair
end note
INSIGHT ->> INSIGHT : create_plantuml_diagrams()
INSIGHT ->> INSIGHT : repairPlantUMLWithLLM()
INSIGHT -->> COORD : insights_and_diagrams
deactivate INSIGHT

COORD ->> OBS : generate_observations(insights)
activate OBS
note right of OBS: Uses LLM
OBS -->> COORD : structured_observations
deactivate OBS

== Classification Phase ==

COORD ->> ONTOLOGY : classify_entities(observations)
activate ONTOLOGY
note right of ONTOLOGY: Uses LLM
ONTOLOGY -->> COORD : classified_entities
deactivate ONTOLOGY

COORD ->> CODEGRAPH : analyze_code_graph()
activate CODEGRAPH
note right of CODEGRAPH: Uses LLM
CODEGRAPH -->> COORD : code_graph_analysis
deactivate CODEGRAPH

COORD ->> DOCLINK : link_documentation()
activate DOCLINK
note right of DOCLINK: Uses LLM
DOCLINK -->> COORD : linked_docs
deactivate DOCLINK

== Validation Phase ==

COORD ->> QA : validate_outputs(observations)
activate QA
note right of QA: Uses LLM
QA -->> COORD : validated_results
deactivate QA

COORD ->> STALE : detect_stale_entities()
activate STALE
STALE -->> COORD : staleness_report
deactivate STALE

COORD ->> CONTENT : validate_entities()
activate CONTENT
CONTENT -->> COORD : validation_results
deactivate CONTENT

== Persistence Phase ==

COORD ->> PERSIST : store_knowledge(validated)
activate PERSIST
PERSIST ->> GRAPHDB : storeEntity()
GRAPHDB -->> PERSIST : stored
PERSIST -->> COORD : persistence_complete
deactivate PERSIST

COORD ->> DEDUP : detect_duplicates()
activate DEDUP
note right of DEDUP: Uses Embeddings
DEDUP ->> GRAPHDB : query_similar()
DEDUP -->> COORD : dedup_complete
deactivate DEDUP

COORD -->> MCP : workflow_results
deactivate COORD

MCP -->> CLAUDE : analysis_response
deactivate MCP

legend right
  |= Color |= Layer |
  | <back:#FFE6CC>   </back> | Orchestration |
  | <back:#E6F3FF>   </back> | Core Analysis |
  | <back:#FFE6E6>   </back> | Quality & Validation |
  | <back:#E6FFE6>   </back> | Infrastructure |
  | <back:#D4EDDA>   </back> | Storage |
endlegend

@enduml
