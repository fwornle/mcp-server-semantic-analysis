@startuml agent-coordination-flow
!include _standard-style.puml

title 10-Agent Coordination Flow - Workflow Execution

participant "Claude Code" as CLAUDE
participant "MCP Handler" as MCP
participant "Coordinator Agent" as COORD #FFE6CC
participant "Git History Agent" as GIT #E6F3FF
participant "Vibe History Agent" as VIBE #E6F3FF
participant "Semantic Analysis Agent" as SEMANTIC #FFE6E6
participant "Web Search Agent" as WEB #E6F3FF
participant "Insight Generation Agent" as INSIGHT #FFE6E6
participant "Observation Generation Agent" as OBS #E6F3FF
participant "Quality Assurance Agent" as QA #FFE6E6
participant "Persistence Agent" as PERSIST #E6F3FF
participant "Deduplication Agent" as DEDUP #E6F3FF
database "GraphDB\n(Graphology+LevelDB)" as GRAPHDB #D4EDDA

CLAUDE ->> MCP : tool_call(execute_workflow)
activate MCP

MCP ->> COORD : execute_workflow(complete-analysis)
activate COORD

note over COORD
  Orchestrate 9-worker-agent workflow:
  Initialize GraphDB adapter
  Initialize execution context
  Manage task dependencies
  Monitor agent performance
end note

COORD ->> GIT : analyze_git_history()
activate GIT
GIT ->> GIT : scan_commits_since_checkpoint()
GIT ->> GIT : extract_architectural_changes()
GIT -->> COORD : git_analysis_results
deactivate GIT

COORD ->> VIBE : analyze_vibe_history()
activate VIBE
VIBE ->> VIBE : parse_specstory_files()
VIBE ->> VIBE : extract_conversation_context()
VIBE -->> COORD : vibe_analysis_results
deactivate VIBE

COORD ->> SEMANTIC : analyze_semantics(git_results, vibe_results)
activate SEMANTIC
note right of SEMANTIC: **Uses LLM**\n3-tier chain
SEMANTIC ->> SEMANTIC : correlate_code_and_conversation()
SEMANTIC ->> SEMANTIC : identify_patterns()
SEMANTIC -->> COORD : semantic_analysis_results
deactivate SEMANTIC

COORD ->> WEB : search_similar_patterns(semantic_results)
activate WEB
WEB ->> WEB : search_external_references()
WEB ->> WEB : validate_documentation()
WEB -->> COORD : web_search_results
deactivate WEB

COORD ->> INSIGHT : generate_comprehensive_insights(all_results)
activate INSIGHT
note right of INSIGHT: **Uses LLM**\n3-tier chain
INSIGHT ->> INSIGHT : synthesize_findings()
INSIGHT ->> INSIGHT : create_plantuml_diagrams()
INSIGHT -->> COORD : insights_and_diagrams
deactivate INSIGHT

COORD ->> OBS : generate_structured_observations(insights)
activate OBS
OBS ->> OBS : create_ukb_compatible_format()
OBS ->> OBS : add_metadata_and_references()
OBS -->> COORD : structured_observations
deactivate OBS

COORD ->> QA : validate_outputs(observations)
activate QA
note right of QA: **Uses LLM**\nfor auto-correction
QA ->> QA : quality_assessment()
QA ->> QA : auto_correction_if_needed()
QA -->> COORD : validated_results
deactivate QA

COORD ->> PERSIST : store_knowledge(validated_results)
activate PERSIST
PERSIST ->> PERSIST : create_checkpoint()
PERSIST ->> GRAPHDB : storeEntity()
activate GRAPHDB
GRAPHDB -->> PERSIST : stored
deactivate GRAPHDB
PERSIST ->> GRAPHDB : storeRelationship()
activate GRAPHDB
GRAPHDB -->> PERSIST : stored
deactivate GRAPHDB
PERSIST -->> COORD : persistence_complete
deactivate PERSIST

COORD ->> DEDUP : detect_and_merge_duplicates()
activate DEDUP
DEDUP ->> GRAPHDB : queryEntities()
activate GRAPHDB
GRAPHDB -->> DEDUP : entities
deactivate GRAPHDB
DEDUP ->> DEDUP : semantic_similarity_analysis()
DEDUP ->> DEDUP : merge_duplicate_entities()
DEDUP -->> COORD : deduplication_complete
deactivate DEDUP

note over COORD
  Final coordination:
  Compile comprehensive results
  Generate execution summary
  Update workflow metrics
end note

COORD -->> MCP : complete_workflow_results
deactivate COORD

MCP -->> CLAUDE : formatted_analysis_response
deactivate MCP

note right of CLAUDE
  Complete 10-agent analysis:
  - Git & conversation correlation
  - External pattern validation
  - Comprehensive insights (3 LLM agents)
  - Quality-assured outputs
  - GraphDB persistence (Graphology+LevelDB)
  - Auto-export to shared-memory-coding.json
  - No MCP Memory server
end note

legend right
  |= Color |= Agent Type |
  | <back:#FFE6E6>   </back> | Uses LLMs (3 agents) |
  | <back:#E6F3FF>   </back> | No LLM (6 agents) |
  | <back:#FFE6CC>   </back> | Orchestrator (1) |
  | <back:#D4EDDA>   </back> | Storage |
endlegend

@enduml