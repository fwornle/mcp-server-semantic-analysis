@startuml mcp-server-architecture
!include /Users/q284340/Agentic/coding/docs/puml/_standard-style.puml

title MCP Semantic Analysis Server - 13-Agent Architecture

package "Claude Code Client" {
  component [Claude Interface] as CLAUDE <<external>>
}

package "MCP Server Core" <<infra>> {
  component [MCP Protocol Handler] as MCP_HANDLER <<infra>>
  component [Tool Registry] as TOOL_REG <<api>>
}

package "Orchestration Layer" <<agent>> #FFE6CC {
  component [Coordinator Agent] as COORDINATOR <<agent>>
}

package "Core Analysis Layer" <<agent>> #E6F3FF {
  component [Git History Agent] as GIT <<agent>>
  component [Vibe History Agent] as VIBE <<agent>>
  component [Semantic Analysis Agent] as SEMANTIC <<agent>>
  component [Web Search Agent] as WEBSEARCH <<agent>>
  component [Insight Generation Agent] as INSIGHT <<agent>>
}

package "Quality & Validation Layer" <<agent>> #FFE6E6 {
  component [Quality Assurance Agent] as QA <<agent>>
  component [Content Validation Agent] as CONTENT <<agent>>
  component [Observation Generation Agent] as OBS <<agent>>
}

package "Infrastructure Layer" <<agent>> #E6FFE6 {
  component [Persistence Agent] as PERSIST <<agent>>
  component [Deduplication Agent] as DEDUP <<agent>>
  component [Git Staleness Detector] as STALE <<agent>>
}

package "Support Layer" <<infra>> #F0F0F0 {
  component [Semantic Analyzer] as ANALYZER <<infra>>
  note right of ANALYZER
    LLM Integration Layer
    5-tier provider chain:
    Groq -> Gemini -> Custom
    -> Anthropic -> OpenAI
  end note
}

package "Storage Layer" <<storage>> {
  database "GraphDB\nGraphology+LevelDB" as GRAPHDB <<storage>> #D4EDDA
  component [GraphKnowledgeExporter] as EXPORTER <<infra>>
  file "knowledge-export/\n<team>.json" as SHARED_JSON <<storage>>
}

package "External Services" <<external>> {
  cloud [LLM Providers] as LLM_CLOUD <<external>> #FFE6E6
  cloud [Web Search APIs] as WEB_API <<external>>
  database [Git Repository] as GIT_REPO <<storage>>
  database [.specstory/history] as VIBE_FILES <<storage>>
}

' Client to MCP
CLAUDE --> MCP_HANDLER : "MCP Protocol"
MCP_HANDLER --> TOOL_REG : "Tool Dispatch"
TOOL_REG --> COORDINATOR : "Orchestration"

' Coordinator orchestrates all agents
COORDINATOR --> GIT
COORDINATOR --> VIBE
COORDINATOR --> SEMANTIC
COORDINATOR --> WEBSEARCH
COORDINATOR --> INSIGHT
COORDINATOR --> OBS
COORDINATOR --> QA
COORDINATOR --> CONTENT
COORDINATOR --> PERSIST
COORDINATOR --> DEDUP
COORDINATOR --> STALE
COORDINATOR ..> GRAPHDB : "Initializes"

' LLM-enhanced agents use SemanticAnalyzer
VIBE ..> ANALYZER
SEMANTIC ..> ANALYZER
WEBSEARCH ..> ANALYZER
INSIGHT ..> ANALYZER
OBS ..> ANALYZER
QA ..> ANALYZER
ANALYZER ..> LLM_CLOUD

' External data sources
GIT --> GIT_REPO
VIBE --> VIBE_FILES
WEBSEARCH --> WEB_API

' Embeddings for deduplication
DEDUP ..> LLM_CLOUD : "Embeddings"

' Storage connections
PERSIST --> GRAPHDB
DEDUP --> GRAPHDB
CONTENT --> GRAPHDB
STALE --> GIT_REPO
GRAPHDB --> EXPORTER
EXPORTER --> SHARED_JSON

legend right
  |= Color |= Layer |
  | <back:#FFE6CC>   </back> | Orchestration (1 agent) |
  | <back:#E6F3FF>   </back> | Core Analysis (5 agents) |
  | <back:#FFE6E6>   </back> | Quality & Validation (3 agents) |
  | <back:#E6FFE6>   </back> | Infrastructure (3 agents) |
  | <back:#F0F0F0>   </back> | Support Layer |
  | <back:#D4EDDA>   </back> | Storage |
endlegend

@enduml
